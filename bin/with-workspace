#!/usr/bin/env -S uv run -q --script

# /// script
# requires-python = ">=3.14"
# dependencies = []
# ///
import json
import os
import subprocess
import sys
from typing import Any, Generator


def is_workspace_file(name: str) -> bool:
    return name.endswith(".code-workspace")


def find_workspaces_in_dir(dir: str) -> Generator[str, None, None]:
    for entry in os.listdir(dir):
        if is_workspace_file(entry):
            yield os.path.join(dir, entry)


def find_workspaces_on_path() -> list[str]:
    dir = os.getcwd()
    while True:
        workspaces = list(find_workspaces_in_dir(dir))
        if workspaces:
            return workspaces
        parent = os.path.dirname(dir)
        if parent == dir:
            break
        dir = parent
    return []


def load_json(path: str) -> dict[str, Any]:
    with open(path, "r", encoding="utf-8") as f:
        return json.load(f)


def with_workspace(workspace_file: str, command: list[str]) -> None:
    workspace_base = os.path.dirname(workspace_file)
    workspace = load_json(workspace_file)
    for folder in workspace.get("folders", []):
        rel_path = folder.get("path")
        if rel_path is None:
            continue
        path = os.path.abspath(os.path.join(workspace_base, rel_path))
        print(path)
        if command:
            res = subprocess.run(command, cwd=path)
            if res.returncode != 0:
                exit(res.returncode)


def main() -> None:
    args = sys.argv[1:]
    if args and (args[0] == "--workspace" or args[0] == "-w"):
        if len(args) < 2:
            print("Expected argument after --workspace", file=sys.stderr)
            exit(1)
        workspace_files = [args[1]]
        args = args[2:]
    else:
        workspace_files = find_workspaces_on_path()
        if len(workspace_files) == 0:
            print("No workspace file found on path", file=sys.stderr)
            exit(1)
        elif len(workspace_files) > 1:
            print("Multiple workspace files found on path", file=sys.stderr)
            exit(1)

    workspace_file = workspace_files[0]
    print(f"Using workspace file: {workspace_file}", file=sys.stderr)
    with_workspace(workspace_file, args)


if __name__ == "__main__":
    main()
