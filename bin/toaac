#!/usr/bin/env perl

use strict;
use warnings;

use File::Find;

find {
  no_chdir => 1,
  wanted   => sub {
    return unless /\.(?:flac|wav)$/i;
    toaac( $_ );
  },
 },
 '.';

sub toaac {
  my $raw = shift;
  ( my $m4a = $raw ) =~ s/\.(\w+)$/.m4a/;
  if ( -f $m4a ) {
    say "Skipping $raw, m4a file already exists";
    return;
  }
  my $tmp = "$m4a.tmp.m4a";
  my @cmd = (
    'ffmpeg',  '-y',      '-i',       $raw,
    '-acodec', 'libfaac', '-ab',      '256k',
    '-ar',     '44100',   '-threads', '0',
    $tmp
  );
  say join ' ', @cmd;
  if ( system @cmd ) {
    say "Conversion failed: $?";
    return;
  }
  unless ( rename $tmp, $m4a ) {
    say "Can't rename $tmp as $m4a";
    unlink $tmp;
  }
}

# vim:ts=2:sw=2:sts=2:et:ft=perl

