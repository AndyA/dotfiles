#!/usr/bin/env perl

use strict;
use warnings;
use File::Find;
use File::Spec;
use Getopt::Long;
use Memoize;

memoize( 'svn_info' );
memoize( 'svn_externals' );

my $all = 0;
GetOptions( 'a' => \$all ) or die "svnroots [-a] [dir ...]\n";

@ARGV = '.' unless @ARGV;

scan( $_ ) for @ARGV;

sub scan {
  my ( $dir, $parent ) = @_;
  my $url = undef;
  if ( -d File::Spec->catdir( $dir, '.svn' ) ) {
    my $info = svn_info( $dir );
    $url = $info->{URL};
    my @path = File::Spec->splitdir( $dir );
    my $leaf = pop @path;
    unless ( defined $parent && $url eq join '/', $parent, $leaf ) {
      my $ext = svn_externals( File::Spec->catdir( @path ) )->{$leaf};
      unless ( defined $ext && $ext eq $url ) {
        print "$dir";
        print "\t$url" if $all;
        print "\n";
      }
    }
  }

  if ( opendir my $dh, $dir ) {
    my @files = grep { -d $_ }
     map { File::Spec->catdir( $dir, $_ ) }
     grep { $_ !~ /^\./ } readdir $dh;
    closedir $dh;
    scan( $_, $url ) for @files;
  }
  else {
    warn "Can't read $dir ($!)\n";
  }
}

sub tidy {
  my $s = shift;
  $s =~ s/^\s+//;
  $s =~ s/\s+$//;
  return $s;
}

sub with_cmd {
  my ( @cmd ) = @_;
  my $code = pop @cmd;
  my $cmd = join ' ', @cmd;
  open my $sh, '-|', @cmd or die "Can't $cmd ($!)\n";
  while ( <$sh> ) { chomp; $code->() }
  close $sh or die "Can't $cmd ($!)\n";
  return $?;
}

sub with_svn {
  my @cmd  = @_;
  my $code = pop @cmd;
  my $info = {};
  with_cmd(
    svn => @cmd,
    sub {
      return if /^\s*$/;
      my ( $k, $v ) = $code->();
      $info->{$k} = $v;
    }
  );
  return $info;
}

sub svn_info {
  with_svn( info => shift, sub { map tidy( $_ ), split /:/, $_, 2 } );
}

sub svn_externals {
  my $dir = shift;
  return {} unless -d File::Spec->catdir( $dir, '.svn' );
  with_svn(
    propget => 'svn:externals',
    $dir, sub { split /\s+/, $_, 2 }
  );
}
