#!/bin/bash

this="/tmp/diffwatch.$$.this"
last="/tmp/diffwatch.$$.last"
poll=1

function _shutdown() {
  rm -f "$this" "$last"
  exit
}

cmd="$*"
trap _shutdown SIGINT
while true; do
  eval $cmd > "$this"
  if [ -e "$last" ]; then
    banner=$( date '+%Y-%m-%d %H:%M:%S' )
    diff "$last" "$this" | while read ln; do
      if [ "$banner" ]; then
        echo "$banner"
        banner=''
      fi
      echo "  $ln"
    done
  fi
  mv "$this" "$last"
  sleep $poll
done

# vim:ts=2:sw=2:sts=2:et:ft=sh

